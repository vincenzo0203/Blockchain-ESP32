{% extends 'base_generic.html' %}

{% block content %}
  <div class="container mt-5">
    <h2>Benvenuto, {{ user.username }}!</h2>
    <p>Questa Ã¨ la tua dashboard.</p>

    <!-- Button to Open Add Person Modal -->
    <button class="btn btn-success mb-3 float-end" data-bs-toggle="modal" data-bs-target="#addPersonModal">Aggiungi Persona</button>

    <!-- Table for Displaying Persons -->
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>RFID</th>
          <th>Nome</th>
          <th>Cognome</th>
          <th>Azioni</th>
        </tr>
      </thead>
      <tbody id="personTableBody">
        {% if people %}
          {% for person in people %}
            <tr id="person-row-{{ person.id }}">
              <td>{{ person.rfid }}</td>
              <td>{{ person.first_name }}</td>
              <td>{{ person.last_name }}</td>
              <td>
                <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#editPersonModal" data-id="{{ person.id }}" data-rfid="{{ person.rfid }}" data-first-name="{{ person.first_name }}" data-last-name="{{ person.last_name }}">Modifica</button>
                <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deletePersonModal" data-id="{{ person.id }}">Cancella</button>
              </td>
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="4" class="text-center">Non ci sono persone registrate</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <!-- Add Person Modal -->
  <div class="modal fade" id="addPersonModal" tabindex="-1" aria-labelledby="addPersonModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addPersonModalLabel">Aggiungi Persona</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addPersonForm">
            {% csrf_token %}
            <div class="mb-3">
              <label for="rfid" class="form-label">RFID</label>
              <input type="text" class="form-control" id="rfid" name="rfid" required>
            </div>
            <div class="mb-3">
              <label for="first_name" class="form-label">Nome</label>
              <input type="text" class="form-control" id="first_name" name="first_name" required>
            </div>
            <div class="mb-3">
              <label for="last_name" class="form-label">Cognome</label>
              <input type="text" class="form-control" id="last_name" name="last_name" required>
            </div>
            <button type="submit" class="btn btn-primary">Aggiungi</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Person Modal -->
  <div class="modal fade" id="editPersonModal" tabindex="-1" aria-labelledby="editPersonModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editPersonModalLabel">Modifica Persona</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editPersonForm">
            {% csrf_token %}
            <input type="hidden" id="edit_person_id" name="id">
            <div class="mb-3">
              <label for="edit_rfid" class="form-label">RFID</label>
              <input type="text" class="form-control" id="edit_rfid" name="rfid" required>
            </div>
            <div class="mb-3">
              <label for="edit_first_name" class="form-label">Nome</label>
              <input type="text" class="form-control" id="edit_first_name" name="first_name" required>
            </div>
            <div class="mb-3">
              <label for="edit_last_name" class="form-label">Cognome</label>
              <input type="text" class="form-control" id="edit_last_name" name="last_name" required>
            </div>
            <button type="submit" class="btn btn-primary float-end">Salva modifiche</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Person Modal -->
  <div class="modal fade" id="deletePersonModal" tabindex="-1" aria-labelledby="deletePersonModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deletePersonModalLabel">Conferma cancellazione</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Sei sicuro di voler cancellare questa persona?</p>
        </div>
        <div class="modal-footer">
          <form id="deletePersonForm" method="POST">
            {% csrf_token %}
            <input type="hidden" id="delete_person_id" name="id">
            <button type="submit" class="btn btn-danger float-end">Cancella</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Handle Edit Button Click to Fill Modal Form
    $('#editPersonModal').on('show.bs.modal', function (event) {
      var button = $(event.relatedTarget);
      var id = button.data('id');
      var rfid = button.data('rfid');
      var first_name = button.data('first-name');
      var last_name = button.data('last-name');

      var modal = $(this);
      modal.find('#edit_person_id').val(id);
      modal.find('#edit_rfid').val(rfid);
      modal.find('#edit_first_name').val(first_name);
      modal.find('#edit_last_name').val(last_name);
    });

    // Handle Add Person Form Submission
    $('#addPersonForm').on('submit', function (e) {
      e.preventDefault();
      var data = $(this).serialize();

      $.ajax({
        type: 'POST',
        url: '{% url "person_add" %}',
        data: data,
        success: function (response) {
          var newPerson = response.person;
          $('#personTableBody').append(`
            <tr id="person-row-${newPerson.id}">
              <td>${newPerson.rfid}</td>
              <td>${newPerson.first_name}</td>
              <td>${newPerson.last_name}</td>
              <td>
                <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#editPersonModal" data-id="${newPerson.id}" data-rfid="${newPerson.rfid}" data-first-name="${newPerson.first_name}" data-last-name="${newPerson.last_name}">Modifica</button>
                <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deletePersonModal" data-id="${newPerson.id}">Cancella</button>
              </td>
            </tr>
          `);
          $('.btn-close').click();  // Simula il clic sul bottone di chiusura
          $('#addPersonForm')[0].reset();
        }
      });
    });

    // Handle Delete Person Form Submission
    $('#deletePersonForm').on('submit', function (e) {
        e.preventDefault();
        var personId = $('#delete_person_id').val();

        $.ajax({
            type: 'POST',
            url: '{% url "person_delete" 0 %}'.replace("0", personId),
            data: {
                id: personId,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function (response) {
                $(`#person-row-${personId}`).remove();
                $('#deletePersonModal').modal('hide');
            },
            error: function (xhr, errmsg, err) {
                console.log("Errore nella richiesta: ", errmsg);
            }
        });
    });
  </script>
{% endblock %}
